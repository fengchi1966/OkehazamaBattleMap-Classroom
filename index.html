<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Okehazama Overlays</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Measure tool -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.css">
  <script src="https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    #panel {
      position: absolute; right: 12px; top: 12px; z-index: 9999;
      width: 340px; max-width: calc(100vw - 24px);
      background: rgba(255,255,255,.96);
      padding: 10px 12px; border-radius: 12px;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      box-shadow: 0 2px 14px rgba(0,0,0,.18);
      max-height: 90vh; overflow: auto;
    }
    #panel h3 { margin: 0 0 8px; font-size: 16px; }
    .layer-row { border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }
    .row-head { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .row-head .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .opacity-row { display:flex; align-items:center; gap:8px; }
    .opacity-row input[type="range"] { flex: 1; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <h3>Overlays</h3>
    <div id="layersUI"></div>
  </div>

  <script>
    // ---------- Map initialization ----------
    const map = L.map('map', { center: [35.2, 136.9], zoom: 7, zoomControl: true });

    // Basemap
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 18, attribution: '&copy; Esri | World Shaded Relief' }
    ).addTo(map);
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 19, opacity: 0.2, attribution: '&copy; Esri | Light Gray Base' }
    ).addTo(map);

    // Scale bar (bottom left)
    L.control.scale({ position: 'bottomleft', imperial: true, metric: true }).addTo(map);

    // Measure tool
    if (L.control && L.control.measure) {
      L.control.measure({
        position: 'topleft',
        primaryLengthUnit: 'miles',
        secondaryLengthUnit: 'feet',
        primaryAreaUnit: 'hectares',
        secondaryAreaUnit: 'sqmeters',
        activeColor: '#e67e22',
        completedColor: '#2c3e50'
      }).addTo(map);
    }

    // High-z overlay pane
    const pane = map.createPane('pngPane');
    pane.style.zIndex = 650;

    // ---------- Overlays config ----------
    const cb = Date.now();
    const overlaysConfig = [
      {
        id: 'battle',
        name: 'Okehazama Battle (1560)',
        png:  `OkehazamaBattle_1560.png?v=${cb}`,
        wld:  `OkehazamaBattle_1560.wld?v=${cb}`,
        color:'#e74c3c',
        defaultOpacity: 0.85,
        checked: true
      },
      {
        id: 'owari',
        name: 'Sengoku Map',
        png:  `Zengoku.png?v=${cb}`,
        wld:  `Zengoku.wld?v=${cb}`,
        color:'#2980b9',
        defaultOpacity: 0.75,
        checked: true
      }
    ];

    const overlayRefs = new Map();
    let unionBounds = null;

    // ---------- Helpers ----------
    async function readText(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`Fetch ${url} failed: ${r.status}`);
      const buf = await r.arrayBuffer();
      return new TextDecoder('utf-8').decode(buf);
    }
    function parseWorldFile(text) {
      const nums = text.trim().split(/[\r\n]+/).map(s => parseFloat(s));
      if (nums.length !== 6 || nums.some(n => Number.isNaN(n))) {
        throw new Error('WLD parse failed: need 6 numeric lines');
      }
      const [A, B, D, E, C, F] = nums;
      return { A, B, D, E, C, F };
    }
    function loadImageSize(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
        img.onerror = () => reject(new Error('PNG load failed: ' + url));
        img.src = url;
      });
    }

    // ---------- Overlay placement ----------
    async function addOverlay(cfg) {
      try {
        const wldText = await readText(cfg.wld);
        const { A, B, D, E, C, F } = parseWorldFile(wldText);
        const { width: W, height: H } = await loadImageSize(cfg.png);

        const corners3857 = [
          [C + A*0 + B*0,   F + D*0 + E*0],
          [C + A*W + B*0,   F + D*W + E*0],
          [C + A*W + B*H,   F + D*W + E*H],
          [C + A*0 + B*H,   F + D*0 + E*H]
        ];
        const cornersLatLng = corners3857.map(([x, y]) =>
          L.CRS.EPSG3857.unproject(L.point(x, y))
        );
        const bounds = L.latLngBounds(cornersLatLng);

        const overlay = L.imageOverlay(cfg.png, bounds, { opacity: cfg.defaultOpacity, pane: 'pngPane', interactive: false });
        const border  = L.polyline([...cornersLatLng, cornersLatLng[0]], { color: cfg.color, weight: 2, opacity: 0.9, pane: 'pngPane' });
        if (cfg.checked) { overlay.addTo(map); border.addTo(map); }

        overlayRefs.set(cfg.id, { overlay, border, bounds });

        unionBounds = unionBounds ? unionBounds.extend(bounds)
                                  : L.latLngBounds(bounds.getSouthWest(), bounds.getNorthEast());
        map.fitBounds(unionBounds.pad(0.05));

      } catch (err) { console.error(err); }
    }

    // ---------- UI ----------
    function buildUI() {
      const box = document.getElementById('layersUI');
      overlaysConfig.forEach(cfg => {
        const row = document.createElement('div');
        row.className = 'layer-row';

        const head = document.createElement('div');
        head.className = 'row-head';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `chk-${cfg.id}`;
        checkbox.checked = !!cfg.checked;

        const swatch = document.createElement('span');
        swatch.className = 'swatch';
        swatch.style.background = cfg.color;

        const label = document.createElement('label');
        label.setAttribute('for', checkbox.id);
        label.textContent = cfg.name;

        head.appendChild(checkbox);
        head.appendChild(swatch);
        head.appendChild(label);

        const opRow = document.createElement('div');
        opRow.className = 'opacity-row';

        const small = document.createElement('span');
        small.textContent = 'Opacity';

        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = '0'; slider.max = '1'; slider.step = '0.05';
        slider.value = cfg.defaultOpacity;
        slider.id = `rng-${cfg.id}`;

        opRow.appendChild(small);
        opRow.appendChild(slider);
        row.appendChild(head);
        row.appendChild(opRow);
        box.appendChild(row);

        // Show/hide
        checkbox.addEventListener('change', () => {
          const ref = overlayRefs.get(cfg.id);
          if (!ref) return;
          if (checkbox.checked) {
            ref.overlay.addTo(map);
            ref.border.addTo(map);
          } else {
            map.removeLayer(ref.overlay);
            map.removeLayer(ref.border);
          }
        });
        // Opacity control
        slider.addEventListener('input', () => {
          const ref = overlayRefs.get(cfg.id);
          if (ref) ref.overlay.setOpacity(parseFloat(slider.value));
        });
      });
    }

    buildUI();
    (async () => {
      for (const cfg of overlaysConfig) await addOverlay(cfg);
    })();
  </script>
</body>
</html>
