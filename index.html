<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Okehazama Overlays — Shaded Relief + Measure + Diagnostics</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Measure tool (optional; we guard if blocked) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.css">
  <script src="https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    #panel, #diag {
      position: absolute; z-index: 9999;
      background: rgba(255,255,255,.96);
      padding: 10px 12px; border-radius: 12px;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      box-shadow: 0 2px 14px rgba(0,0,0,.18);
      max-width: min(420px, calc(100vw - 24px));
      overflow: auto; max-height: 90vh;
    }
    #panel { right: 12px; top: 12px; width: 340px; }
    #panel h3 { margin: 0 0 8px; font-size: 16px; }
    .layer-row { border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }
    .row-head { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .row-head .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .row-head label { font-weight: 600; cursor: pointer; }
    .opacity-row { display:flex; align-items:center; gap:8px; }
    .opacity-row input[type="range"] { flex: 1; }

    #diag { left: 12px; top: 12px; width: 360px; }
    #diag h3 { margin: 0 0 8px; font-size: 16px; }
    .diag-box {
      font-family: ui-monospace, Consolas, monospace;
      font-size: 12px; white-space: pre-wrap;
      background: #fafafa; border: 1px solid #eee;
      border-radius: 8px; padding: 8px; margin: 8px 0;
    }
    .ok{color:#1e7e34} .err{color:#c0392b} .warn{color:#d68910}
    .btn{appearance:none;border:1px solid #ddd;background:#fff;border-radius:6px;padding:2px 8px;cursor:pointer}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <h3>Overlays</h3>
    <div id="layersUI"></div>
  </div>

  <div id="diag">
    <h3>Diagnostics</h3>
    <div id="diagList" class="diag-box">booting…</div>
  </div>

  <script>
    // ---------- simple logger to the Diagnostics panel ----------
    const diagList = document.getElementById('diagList');
    function log(msg, cls){ 
      const p = document.createElement('div'); 
      p.className = cls ? `diag-box ${cls}` : 'diag-box'; 
      p.textContent = msg; 
      diagList.after(p);
    }
    function appendTo(el, msg){ el.textContent += '\\n' + msg; }

    // Catch any unexpected runtime errors and show them on page
    window.addEventListener('error', e => { log('Uncaught: ' + e.message, 'err'); });
    window.addEventListener('unhandledrejection', e => { log('Unhandled promise rejection: ' + (e.reason && e.reason.message || e.reason), 'err'); });

    (async function main(){
      try {
        const CB = Date.now(); // cache buster

        // ---------- map ----------
        const map = L.map('map', { center: [35.2, 136.9], zoom: 10, zoomControl: true });
        L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',
          { maxZoom: 18, attribution: '&copy; Esri | World Shaded Relief' }
        ).addTo(map);
        L.tileLayer(
          'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
          { maxZoom: 19, opacity: 0.2, attribution: '&copy; Esri | Light Gray Base' }
        ).addTo(map);

        // high-z pane for overlays
        const pane = map.createPane('pngPane');
        pane.style.zIndex = 650;

        // measure tool (guarded)
        //try {
         // if (L.control && L.control.measure) {
            L.control.measure({
              position: 'topleft',
              primaryLengthUnit: 'miles',
              secondaryLengthUnit: 'feet',
              primaryAreaUnit: 'hectares',
              secondaryAreaUnit: 'sqmeters',
              activeColor: '#e67e22',
              completedColor: '#2c3e50'
            }).addTo(map);
            log('measure tool: OK', 'ok');
          } else {
            log('measure tool not available — plugin blocked; continuing without it.', 'warn');
          }
        } catch (e) {
          log('measure init failed: ' + e.message, 'warn');
        }

        // ---------- config ----------
        const overlaysConfig = [
          {
            id: 'battle',
            name: 'Okehazama Battle (1560)',
            png:  `OkehazamaBattle_1560.png?v=${CB}`,
            wld:  `OkehazamaBattle_1560.wld?v=${CB}`,
            color:'#e74c3c',
            defaultOpacity: 0.85,
            checked: true
          },
          {
            id: 'owari',
            name: 'Zengoku Map',
            png:  `Zengoku.png?v=${CB}`,
            wld:  `Zengoku.wld?v=${CB}`,
            color:'#2980b9',
            defaultOpacity: 0.75,
            checked: true
          }
        ];

        const overlayRefs = new Map();
        let unionBounds = null;

        // ---------- helpers ----------
        async function checkGET(url){
          const r = await fetch(url, { method: 'GET', cache: 'no-store' });
          return { ok: r.ok, status: r.status };
        }
        async function readText(url){
          const r = await fetch(url, { cache: 'no-store' });
          if(!r.ok) throw new Error(`fetch ${url} failed: ${r.status}`);
          const buf = await r.arrayBuffer();
          return new TextDecoder('utf-8').decode(buf);
        }
        function parseWLD(text){
          const nums = text.trim().split(/[\r\\n]+/).map(s => parseFloat(s));
          if (nums.length !== 6 || nums.some(n => Number.isNaN(n))) {
            throw new Error('WLD parse failed: need 6 numeric lines');
          }
          const [A,B,D,E,C,F] = nums;
          return {A,B,D,E,C,F};
        }
        function loadImageSize(url){
          return new Promise((resolve,reject)=>{
            const img = new Image();
            img.onload = ()=> resolve({width: img.naturalWidth, height: img.naturalHeight});
            img.onerror = ()=> reject(new Error('PNG load failed: ' + url));
            img.src = url;
          });
        }

        function addDiagHeader(cfg){
          const d = document.createElement('div');
          d.className = 'diag-box';
          d.id = 'diag-' + cfg.id;
          d.textContent = `▶ ${cfg.name}\\nPNG: ${cfg.png}\\nWLD: ${cfg.wld}`;
          document.body.appendChild(d);
          return d;
        }

        async function addOverlay(cfg){
          const box = addDiagHeader(cfg);
          try{
            const [pg, wg] = await Promise.all([checkGET(cfg.png), checkGET(cfg.wld)]);
            appendTo(box, `PNG GET: ${pg.status} ${pg.ok?'OK':'ERR'}`);
            appendTo(box, `WLD GET: ${wg.status} ${wg.ok?'OK':'ERR'}`);
            if(!pg.ok) throw new Error('PNG not reachable');
            if(!wg.ok) throw new Error('WLD not reachable');

            const wld = parseWLD(await readText(cfg.wld));
            const {width:W, height:H} = await loadImageSize(cfg.png);
            appendTo(box, `size: ${W} × ${H}`);
            appendTo(box, `A=${wld.A} B=${wld.B} D=${wld.D} E=${wld.E} C=${wld.C} F=${wld.F}`);

            // world file math in EPSG:3857
            const corners3857 = [
              [wld.C + wld.A*0 + wld.B*0,   wld.F + wld.D*0 + wld.E*0],
              [wld.C + wld.A*W + wld.B*0,   wld.F + wld.D*W + wld.E*0],
              [wld.C + wld.A*W + wld.B*H,   wld.F + wld.D*W + wld.E*H],
              [wld.C + wld.A*0 + wld.B*H,   wld.F + wld.D*0 + wld.E*H]
            ];
            const cornersLatLng = corners3857.map(([x,y]) => L.CRS.EPSG3857.unproject(L.point(x,y)));
            const bounds = L.latLngBounds(cornersLatLng);
            appendTo(box, `bounds: SW(${bounds.getSouthWest().lat.toFixed(5)}, ${bounds.getSouthWest().lng.toFixed(5)}) NE(${bounds.getNorthEast().lat.toFixed(5)}, ${bounds.getNorthEast().lng.toFixed(5)})`);

            const overlay = L.imageOverlay(cfg.png, bounds, {opacity: cfg.defaultOpacity, pane:'pngPane', interactive:false});
            if (cfg.checked) overlay.addTo(map);
            const border  = L.polyline([...cornersLatLng, cornersLatLng[0]], {color: cfg.color, weight:2, opacity:.9, pane:'pngPane'});
            if (cfg.checked) border.addTo(map);

            overlayRefs.set(cfg.id, { overlay, border, bounds });

            unionBounds = unionBounds ? unionBounds.extend(bounds)
                                      : L.latLngBounds(bounds.getSouthWest(), bounds.getNorthEast());
            map.fitBounds(unionBounds.pad(0.05));

            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = 'Zoom to layer';
            btn.onclick = ()=> map.fitBounds(bounds.pad(0.05));
            box.appendChild(document.createTextNode('\\n'));
            box.appendChild(btn);
            box.appendChild(document.createTextNode('\\n✓ added'));
            box.classList.add('ok');
          }catch(err){
            box.classList.add('err');
            appendTo(box, '✖ ' + err.message);
            console.error(err);
          }
        }

        // UI
        function buildUI(){
          const box = document.getElementById('layersUI');
          overlaysConfig.forEach(cfg=>{
            const row = document.createElement('div');
            row.className = 'layer-row';

            const head = document.createElement('div');
            head.className = 'row-head';

            const chk = document.createElement('input');
            chk.type = 'checkbox'; chk.id = 'chk-'+cfg.id; chk.checked = !!cfg.checked;

            const sw = document.createElement('span');
            sw.className = 'swatch'; sw.style.background = cfg.color;

            const lab = document.createElement('label');
            lab.setAttribute('for', chk.id); lab.textContent = cfg.name;

            head.appendChild(chk); head.appendChild(sw); head.appendChild(lab);

            const op = document.createElement('div');
            op.className = 'opacity-row';
            const s = document.createElement('span'); s.textContent = 'Opacity';
            const rng = document.createElement('input');
            rng.type='range'; rng.min='0'; rng.max='1'; rng.step='0.05'; rng.value = cfg.defaultOpacity;

            op.appendChild(s); op.appendChild(rng);
            row.appendChild(head); row.appendChild(op);
            box.appendChild(row);

            chk.addEventListener('change', ()=>{
              const ref = overlayRefs.get(cfg.id); if(!ref) return;
              if(chk.checked){ ref.overlay.addTo(map); ref.border.addTo(map); }
              else { map.removeLayer(ref.overlay); map.removeLayer(ref.border); }
            });
            rng.addEventListener('input', ()=>{
              const ref = overlayRefs.get(cfg.id); if(ref) ref.overlay.setOpacity(parseFloat(rng.value));
            });
          });
        }

        buildUI();
        for (const cfg of overlaysConfig) { await addOverlay(cfg); }
        log('init finished', 'ok');

      } catch (e) {
        log('main failed: ' + e.message, 'err');
        console.error(e);
      }
    })();
  </script>
</body>
</html>
