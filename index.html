<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Okehazama Overlays — robust loader + diagnostics</title>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    #panel, #diag {
      position: absolute; z-index: 9999;
      background: rgba(255,255,255,.96);
      padding: 10px 12px; border-radius: 12px;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      box-shadow: 0 2px 14px rgba(0,0,0,.18);
      max-width: min(420px, calc(100vw - 24px));
      overflow: auto; max-height: 90vh;
    }
    #panel { right: 12px; top: 12px; width: 340px; }
    #panel h3 { margin: 0 0 8px; font-size: 16px; }
    .layer-row { border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px; }
    .row-head { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .row-head .swatch { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .opacity-row { display:flex; align-items:center; gap:8px; }
    .opacity-row input[type="range"] { flex: 1; }

    #diag { left: 12px; top: 12px; width: 360px; }
    #diag h3 { margin: 0 0 8px; font-size: 16px; }
    .diag { font-family: ui-monospace,Consolas,monospace; font-size: 12px;
            background:#fafafa; border:1px solid #eee; border-radius:8px;
            padding:8px; margin:8px 0; white-space:pre-wrap; }
    .ok{color:#1e7e34} .err{color:#c0392b} .warn{color:#d68910}
    .btn{appearance:none;border:1px solid #ddd;background:#fff;border-radius:6px;padding:2px 8px;cursor:pointer}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <h3>Overlays</h3>
    <div id="layersUI"></div>
  </div>

  <div id="diag">
    <h3>Diagnostics</h3>
    <div id="d0" class="diag">booting…</div>
  </div>

  <script>
    // -------- diagnostics helpers --------
    const d0 = document.getElementById('d0');
    function diagLine(msg, cls){
      const el = document.createElement('div');
      el.className = 'diag ' + (cls||'');
      el.textContent = msg;
      d0.after(el);
      return el;
    }
    window.addEventListener('error', e => diagLine('Uncaught: ' + e.message, 'err'));
    window.addEventListener('unhandledrejection', e => diagLine('Unhandled rejection: ' + (e.reason?.message || e.reason), 'err'));

    // -------- dynamic loader with fallbacks --------
    function loadCSS(hrefs){
      return new Promise(resolve=>{
        let i=0;
        const tryNext=()=>{
          if(i>=hrefs.length) return resolve(false);
          const link = document.createElement('link');
          link.rel='stylesheet'; link.href=hrefs[i++];
          link.onload=()=>resolve(true);
          link.onerror=tryNext; // try next if blocked
          document.head.appendChild(link);
        };
        tryNext();
      });
    }
    function loadScriptSeq(urls, globalCheck){
      return new Promise((resolve,reject)=>{
        let i=0;
        const tryNext=()=>{
          if (i>=urls.length) return reject(new Error('all sources failed for ' + urls.join(', ')));
          const s=document.createElement('script');
          s.src = urls[i++]; s.async=true;
          s.onload=()=> {
            setTimeout(()=>{
              if(globalCheck && !globalCheck()){
                // sometimes 200 but CSP blocks execution
                tryNext();
              } else resolve(true);
            }, 0);
          };
          s.onerror=tryNext;
          document.head.appendChild(s);
        };
        tryNext();
      });
    }

    (async function boot(){
      const cb = Date.now();
      // Leaflet CSS
      diagLine('Loading Leaflet CSS…');
      await loadCSS([
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css',
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'
      ]);

      // Leaflet JS with triple fallback
      const lfDiag = diagLine('Loading Leaflet JS…');
      try{
        await loadScriptSeq([
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
          'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js',
          'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'
        ], ()=>!!window.L);
        lfDiag.textContent = 'Leaflet: OK';
        lfDiag.classList.add('ok');
      }catch(e){
        lfDiag.textContent = 'Leaflet: failed — ' + e.message;
        lfDiag.classList.add('err');
        return; // cannot continue without Leaflet
      }

      // Optional measure tool
      const msDiag = diagLine('Loading measure plugin (optional)…');
      try{
        await loadCSS([
          'https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.css',
          'https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.1/dist/leaflet-measure.css'
        ]);
        await loadScriptSeq([
          'https://unpkg.com/leaflet-measure@3.3.1/dist/leaflet-measure.min.js',
          'https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.1/dist/leaflet-measure.min.js'
        ], ()=>!!(window.L && L.control && L.control.measure));
        msDiag.textContent = 'measure: OK';
        msDiag.classList.add('ok');
      }catch(e){
        msDiag.textContent = 'measure: unavailable — ' + e.message;
        msDiag.classList.add('warn');
      }

      // -------- init map (zoom 7) --------
      const map = L.map('map', { center: [35.2, 136.9], zoom: 7, zoomControl: true });
      L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 18, attribution: '&copy; Esri | World Shaded Relief' }
      ).addTo(map);
      L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 19, opacity: 0.2, attribution: '&copy; Esri | Light Gray Base' }
      ).addTo(map);

      if (L.control?.measure){
        L.control.measure({
          position: 'topleft',
          primaryLengthUnit: 'miles',
          secondaryLengthUnit: 'feet',
          primaryAreaUnit: 'hectares',
          secondaryAreaUnit: 'sqmeters',
          activeColor: '#e67e22',
          completedColor: '#2c3e50'
        }).addTo(map);
      }

      // high-z pane for overlays
      const pane = map.createPane('pngPane');
      pane.style.zIndex = 650;

      // -------- overlay helpers --------
      const overlaysConfig = [
        {
          id: 'battle',
          name: 'Okehazama Battle (1560)',
          png:  `OkehazamaBattle_1560.png?v=${cb}`,
          wld:  `OkehazamaBattle_1560.wld?v=${cb}`,
          color:'#e74c3c',
          defaultOpacity: 0.85,
          checked: true
        },
        {
          id: 'owari',
          name: 'Zengoku Map',
          png:  `Zengoku.png?v=${cb}`,
          wld:  `Zengoku.wld?v=${cb}`,
          color:'#2980b9',
          defaultOpacity: 0.75,
          checked: true
        }
      ];

      const overlayRefs = new Map();
      let unionBounds = null;

      function uiBuild(){
        const box = document.getElementById('layersUI');
        overlaysConfig.forEach(cfg=>{
          const row = document.createElement('div'); row.className='layer-row';
          const head = document.createElement('div'); head.className='row-head';
          const chk = Object.assign(document.createElement('input'), {type:'checkbox', id:'chk-'+cfg.id, checked: !!cfg.checked});
          const sw  = document.createElement('span'); sw.className='swatch'; sw.style.background=cfg.color;
          const lab = document.createElement('label'); lab.htmlFor = chk.id; lab.textContent = cfg.name;
          head.append(chk, sw, lab);

          const op = document.createElement('div'); op.className='opacity-row';
          const small = document.createElement('span'); small.textContent = 'Opacity';
          const rng = Object.assign(document.createElement('input'), {type:'range', min:'0', max:'1', step:'0.05', value: cfg.defaultOpacity});
          op.append(small, rng);

          row.append(head, op); box.append(row);

          chk.addEventListener('change', ()=>{
            const ref = overlayRefs.get(cfg.id); if(!ref) return;
            if (chk.checked){ ref.overlay.addTo(map); ref.border.addTo(map); }
            else { map.removeLayer(ref.overlay); map.removeLayer(ref.border); }
          });
          rng.addEventListener('input', ()=>{
            const ref = overlayRefs.get(cfg.id); if(ref) ref.overlay.setOpacity(parseFloat(rng.value));
          });
        });
      }

      async function getText(url){
        const r = await fetch(url, {cache:'no-store'});
        if(!r.ok) throw new Error(`GET ${url} → ${r.status}`);
        const buf = await r.arrayBuffer();
        return new TextDecoder('utf-8').decode(buf);
      }
      function parseWLD(text){
        const nums = text.trim().split(/[\r\n]+/).map(s=>parseFloat(s));
        if(nums.length!==6 || nums.some(n=>Number.isNaN(n))) throw new Error('WLD parse failed (need 6 numbers)');
        const [A,B,D,E,C,F] = nums;
        return {A,B,D,E,C,F};
      }
      function imgSize(url){
        return new Promise((res,rej)=>{
          const img = new Image(); img.onload = ()=>res({w:img.naturalWidth,h:img.naturalHeight});
          img.onerror = ()=>rej(new Error('PNG load failed: '+url));
          img.src = url;
        });
      }
      async function addOverlay(cfg){
        const box = diagLine(`▶ ${cfg.name}\nPNG: ${cfg.png}\nWLD: ${cfg.wld}`);
        try{
          const wldText = await getText(cfg.wld);
          const {A,B,D,E,C,F} = parseWLD(wldText);
          const {w:W,h:H} = await imgSize(cfg.png);
          box.textContent += `\nsize: ${W} × ${H}\nA=${A} B=${B} D=${D} E=${E} C=${C} F=${F}`;

          const corners3857 = [
            [C + A*0 + B*0,   F + D*0 + E*0],
            [C + A*W + B*0,   F + D*W + E*0],
            [C + A*W + B*H,   F + D*W + E*H],
            [C + A*0 + B*H,   F + D*0 + E*H]
          ];
          const cornersLatLng = corners3857.map(([x,y])=>L.CRS.EPSG3857.unproject(L.point(x,y)));
          const bounds = L.latLngBounds(cornersLatLng);
          box.textContent += `\nbounds: SW(${bounds.getSouthWest().lat.toFixed(5)}, ${bounds.getSouthWest().lng.toFixed(5)}) NE(${bounds.getNorthEast().lat.toFixed(5)}, ${bounds.getNorthEast().lng.toFixed(5)})`;

          const overlay = L.imageOverlay(cfg.png, bounds, {opacity: cfg.defaultOpacity, pane:'pngPane', interactive:false});
          const border  = L.polyline([...cornersLatLng, cornersLatLng[0]], {color: cfg.color, weight:2, opacity:.9, pane:'pngPane'});
          if (cfg.checked){ overlay.addTo(map); border.addTo(map); }

          overlayRefs.set(cfg.id, {overlay,border,bounds});

          unionBounds = unionBounds ? unionBounds.extend(bounds)
                                    : L.latLngBounds(bounds.getSouthWest(), bounds.getNorthEast());
          map.fitBounds(unionBounds.pad(0.05));

          const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Zoom to layer';
          btn.onclick = ()=> map.fitBounds(bounds.pad(0.05));
          box.append(document.createTextNode('\n'), btn);
          box.classList.add('ok');
        }catch(e){
          box.textContent += '\n✖ ' + e.message;
          box.classList.add('err');
          console.error(e);
        }
      }

      uiBuild();
      for (const cfg of overlaysConfig) await addOverlay(cfg);
      diagLine('init finished', 'ok');
    })();
  </script>
</body>
</html>
